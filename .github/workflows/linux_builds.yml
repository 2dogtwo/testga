name: ðŸ§ Linux gd- Builds
on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write
 
# Global Settings
env:
  SCONS_FLAGS: >-
    disable_xr=yes 
    engine_update_check=no 
    module_camera_enabled=no 
    module_mobile_vr_enabled=no 
    module_openxr_enabled=no 
    module_webxr_enabled=no 
    vulkan=no  
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  ASAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/asan.txt
  LSAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/lsan.txt
  TSAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/tsan.txt
  UBSAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/ubsan.txt

jobs:
  build-linux:
    # Stay one LTS before latest to increase portability of Linux artifacts.
    runs-on: ubuntu-22.04-arm
    name: ${{ matrix.name }}
    timeout-minutes: 420
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-editor-gd-jllvm
            cache-name: linux-editor-gd-jllvm
            target: editor
            scons-flags: use_llvm=yes
            bin: ./bin/godot.linuxbsd.editor.arm64.llvm
            
            
            
          - name: linux-editor-gd-thinall
            cache-name: linux-editor-gd-thinall
            target: editor
            scons-flags: >-             
              use_llvm=yes
              linker=lld
              lto=thin
            bin: ./bin/godot.linuxbsd.editor.arm64.llvm
            # Test our oldest supported SCons/Python versions on one arbitrary editor build.
            
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install libwayland-bin  # TODO: Figure out somehow how to embed this one.

      - name: Free disk space on runner
        run: |
          echo "Disk usage before:" && df -h
          sudo rm -rf /usr/local/lib/android
          mkdir -p ./bin/
          echo "Disk usage after:" && df -h







      - name: Prepare artifact
        run: |
          echo "Disk usage after:" >> ${{ matrix.bin }}

      - name: Upload artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.cache-name }}
          files: |
            ./bin/*.zip

      - name: Unit tests
        run: |
          ls -laRt bin/
          ls -laRt ./
          
      - name: Unit tests2
        run: |          
          ls -laRt /

