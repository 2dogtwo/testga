name: üêß Linux gd- Builds
on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write
 
# Global Settings
env:
  SCONS_FLAGS: >-
    disable_xr=yes 
    engine_update_check=no 
    module_camera_enabled=no 
    module_mobile_vr_enabled=no 
    module_openxr_enabled=no 
    module_webxr_enabled=no 
    vulkan=no  
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  ASAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/asan.txt
  LSAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/lsan.txt
  TSAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/tsan.txt
  UBSAN_OPTIONS: color=always:print_suppressions=1:suppressions=${{ github.workspace }}/misc/error_suppressions/ubsan.txt

jobs:
  build-linux:
    # Stay one LTS before latest to increase portability of Linux artifacts.
    runs-on: ubuntu-22.04-arm
    name: ${{ matrix.name }}
    timeout-minutes: 420
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-editor-gd-jllvm
            cache-name: linux-editor-gd-jllvm
            target: editor
            scons-flags: use_llvm=yes
            bin: ./bin/godot.linuxbsd.editor.arm64.llvm
            
            
            
          - name: linux-editor-gd-thinall
            cache-name: linux-editor-gd-thinall
            target: editor
            scons-flags: >-             
              use_llvm=yes
              linker=lld
              lto=thin
            bin: ./bin/godot.linuxbsd.editor.arm64.llvm
            # Test our oldest supported SCons/Python versions on one arbitrary editor build.
            
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install libwayland-bin  # TODO: Figure out somehow how to embed this one.

      - name: Free disk space on runner
        run: |
          echo "Disk usage before:" && df -h
          sudo rm -rf /usr/local/lib/android
          mkdir -p ./bin/
          echo "Disk usage after:" && df -h







      - name: Prepare artifact
        run: |
          echo "Disk usage after:" >> ${{ matrix.bin }}

      - name: Upload artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}


      - name: Unit tests
        run: |
          ls -laRt bin/
          ls -laRt ./
          


# MY_LIST ‰∏∫ item1,item2,item3„ÄÇ
# Âú®ËÑöÊú¨‰∏≠ÔºåÂèØ‰ª•‰ΩøÁî® IFS=',' read -ra ITEMS <<< "$MY_LIST

  release:
    needs: [build-linux]
    runs-on: "ubuntu-22.04"
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-editor-gd-jllvm
          path: artifacts/linux


      - name: Download MacOS artifact
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          name: linux-editor-gd-thinall
          path: artifacts/linux2

      - name: Zip artifacts
        run: |
          pwd
          echo "CURRENT_DIR=$(pwd)" >> $GITHUB_ENV
          ls -laRt artifacts/*
          cd artifacts/linux
          zip -r9  "../linux-editor-gd-jllvm.zip" *
          # cd /home/runner/work/testga/testga
          cd  $CURRENT_DIR
          echo "$CURRENT_DIR" 
          echo "$($CURRENT_DIR)" 
          pwd
          cd artifacts/linux2
          pwd
          zip -r9  "../linux-editor-gd-thinall.zip" *
 
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Linux-gd-Builds
          files: |
            artifacts/*.zip
